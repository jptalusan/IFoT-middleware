#docker-compose.yml
version: '3'

#Note: Not sure if I need to change
#something with the image/build
#Dockerfile contains online docker image, but image in docker-compose
#is named as the local registry docker image. If they are both named
#as local registry docker image, i think i encounter some problem
#regarding allocation? Or is it because i failed to use build/context, dockerfile params.

services:
  frontend:
    container_name: ifot_api_frontend
    image: 127.0.0.1:5000/nuc-ifot-frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "5001:5001"
    expose:
      - "5001"
    command: python manage.py run -h 0.0.0.0 -p 5001
    volumes:
      #- /home/jp-nuc/jane/IFoT-middleware/frontend:/usr/src/app
      - ./frontend:/usr/src/app
      - ./common:/usr/src/app/project/common
    deploy:
      placement:
        constraints:
          - node.role == manager
      # restart_policy:
      #   condition: any
      #   delay: 5s
      #   window: 10s
      #   max_attempts: 5
    environment:
      - FLASK_DEBUG=1
      - APP_SETTINGS=project.server.config.DevelopmentConfig
      - WTF_CSRF_ENABLED = False
      - PYTHONUNBUFFERED=1
    depends_on:
      - redis

  ### BEGIN AUTOGENERATED BLOCK ###
  
  #Backend simply just running redis rq worker
  #needs task files to be deployed in all workers
  backend0000:
    image: 127.0.0.1:5000/nuc-ifot-worker
    build:
      context: ./backend_uniq
      dockerfile: Dockerfile
    ports:
      - "5150:5008"
    command: python3 worker.py
    volumes:
      - ./backend_uniq:/usr/src/app
      - ./common:/usr/src/app/common
      - ./backend_data/backend0000:/usr/src/app/data
    #restart: always
    depends_on:
      - redis
      - frontend
    deploy:
      mode: replicated
      restart_policy:
        condition: any
    environment:
      - PYTHONUNBUFFERED=2

  #Backend simply just running redis rq worker
  #needs task files to be deployed in all workers
  backend0001:
    image: 127.0.0.1:5000/nuc-ifot-worker
    build:
      context: ./backend_uniq
      dockerfile: Dockerfile
    ports:
      - "5151:5008"
    command: python3 worker.py
    volumes:
      - ./backend_uniq:/usr/src/app
      - ./common:/usr/src/app/common
      - ./backend_data/backend0001:/usr/src/app/data
    #restart: always
    depends_on:
      - redis
      - frontend
    deploy:
      mode: replicated
      restart_policy:
        condition: any
    environment:
      - PYTHONUNBUFFERED=2

  #Backend simply just running redis rq worker
  #needs task files to be deployed in all workers
  backend0002:
    image: 127.0.0.1:5000/nuc-ifot-worker
    build:
      context: ./backend_uniq
      dockerfile: Dockerfile
    ports:
      - "5152:5008"
    command: python3 worker.py
    volumes:
      - ./backend_uniq:/usr/src/app
      - ./common:/usr/src/app/common
      - ./backend_data/backend0002:/usr/src/app/data
    #restart: always
    depends_on:
      - redis
      - frontend
    deploy:
      mode: replicated
      restart_policy:
        condition: any
    environment:
      - PYTHONUNBUFFERED=2

  #Backend simply just running redis rq worker
  #needs task files to be deployed in all workers
  backend0003:
    image: 127.0.0.1:5000/nuc-ifot-worker
    build:
      context: ./backend_uniq
      dockerfile: Dockerfile
    ports:
      - "5153:5008"
    command: python3 worker.py
    volumes:
      - ./backend_uniq:/usr/src/app
      - ./common:/usr/src/app/common
      - ./backend_data/backend0003:/usr/src/app/data
    #restart: always
    depends_on:
      - redis
      - frontend
    deploy:
      mode: replicated
      restart_policy:
        condition: any
    environment:
      - PYTHONUNBUFFERED=2

  #Backend simply just running redis rq worker
  #needs task files to be deployed in all workers
  backend0004:
    image: 127.0.0.1:5000/nuc-ifot-worker
    build:
      context: ./backend_uniq
      dockerfile: Dockerfile
    ports:
      - "5154:5008"
    command: python3 worker.py
    volumes:
      - ./backend_uniq:/usr/src/app
      - ./common:/usr/src/app/common
      - ./backend_data/backend0004:/usr/src/app/data
    #restart: always
    depends_on:
      - redis
      - frontend
    deploy:
      mode: replicated
      restart_policy:
        condition: any
    environment:
      - PYTHONUNBUFFERED=2

  ### AUTOGENERATED BLOCK END ###

  aggregator:
    image: 127.0.0.1:5000/nuc-ifot-worker
    ports:
      - "5003:5003"
    command: python3 worker.py
    volumes:
      - ./aggregator:/usr/src/app
      - ./common:/usr/src/app/common
    depends_on:
      - redis
    environment:
      - PYTHONUNBUFFERED=2

  redis:
    container_name: redis
    image: redis
    ports:
      - "6379:6379"
    restart: always
    deploy:
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: any
    #logging:
    #  driver: "none"
    # command: ["redis-server", "--appendonly", "yes"]
    # hostname: redis

  redis_dashboard:
    build: ./redis_dashboard
    #image: ifot/r_dashboard
    image: 127.0.0.1:5000/nuc-ifot-dashboard
    container_name: redis_dashboard
    ports:
      - "9181:9181"
    command: rq-dashboard -H redis

  viz:
    image: dockersamples/visualizer
    ports:
      - "8080:8080"
    deploy:
      placement:
        constraints:
          - node.role == manager
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

networks:
  bridge:
    external:
      name: mynet
